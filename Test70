def backtest_delta_strategy_swap(
    y_bp,
    z_raw,
    delta_size=10000,
    z_entry=1.5,
    z_exit=0.5,
    hedge_cost_per_bp=0.20,
    ewma_span=20,
):
    df = pd.DataFrame({"y": y_bp, "z_raw": z_raw}).dropna()
    df["z_ewma"] = df["z_raw"].ewm(span=ewma_span, adjust=False).mean()

    pos = 0.0
    last_entry = None
    pos_list = []

    for t in df.index:
        prev = pos
        zE = df.loc[t, "z_ewma"]
        zR = df.loc[t, "z_raw"]

        if abs(zR) <= z_exit:
            pos = 0.0
        else:
            if zE <= -z_entry:
                pos = +delta_size
            elif zE >= z_entry:
                pos = -delta_size

        if prev == 0 and pos != 0:
            last_entry = t

        pos_list.append(pos)

    df["pos"] = pos_list
    df["dy"] = df["y"].diff()
    df["pnl_gross"] = df["pos"].shift(1).fillna(0) * df["dy"]

    df["turnover"] = df["pos"].diff().abs().fillna(df["pos"].abs())
    df["hedge_cost"] = hedge_cost_per_bp * df["turnover"]
    df["pnl_net"] = df["pnl_gross"] - df["hedge_cost"]

    df["pnl_cum_net"] = df["pnl_net"].cumsum()

    sharpe = (
        df["pnl_net"].mean() / (df["pnl_net"].std() + 1e-12) * np.sqrt(252)
    )
    maxdd = (df["pnl_cum_net"] - df["pnl_cum_net"].cummax()).min()

    return {
        "df": df,
        "FinalPnL_net": df["pnl_cum_net"].iloc[-1],
        "Sharpe_net": sharpe,
        "MaxDD_net": maxdd,
        "LastZ": df["z_raw"].iloc[-1],
        "LastEntry": last_entry,
        "LastPos": df["pos"].iloc[-1],
        "HedgeCostCum": df["hedge_cost"].sum(),
    }


def backtest_all_tenors(model, k, roll, ewma_span):
    ret_hat = reconstruct_returns(model)
    ret = model["returns"]
    levels = model["levels"]

    perf = {}
    pnl_curves = {}

    for t in ret.columns:
        resid = ret[t] - ret_hat[t]
        z = (resid - resid.rolling(roll).mean()) / resid.rolling(roll).std()

        bt = backtest_delta_strategy_swap(
            y_bp=levels[t],
            z_raw=z,
            ewma_span=ewma_span,
        )

        perf[t] = bt
        pnl_curves[t] = bt["df"]["pnl_cum_net"]

    perf_df = pd.DataFrame(perf).T
    pnl_curves = pd.DataFrame(pnl_curves)

    return perf_df, pnl_curves
